	#include "stm32f411xe.h"
	#include "stm32f4xx.h"
	#include <stdint.h>
	#include "string.h"

	uint8_t UART_RX(uint8_t temp);
	int msTicks = 0;
	void delayMs(int ms);

	int main() {

		RCC -> AHB1ENR |= RCC_AHB1ENR_GPIOAEN | RCC_AHB1ENR_GPIOCEN;
		RCC -> APB1ENR |= RCC_APB1ENR_USART2EN;

		// setup board User KEY button
		GPIOA -> MODER &= ~0x03; // Clear MODER0 → PA0 as input
		GPIOA -> PUPDR &= ~0x03; // Clear PUPDR0 bits
		GPIOA -> PUPDR |= 0x01; // Set PUPDR0 = 01 → pull-up

		// setup board LED
		GPIOC -> MODER &= ~(0x03 << (2 * 13)); // Clear MODER13 bits
		GPIOC -> MODER |= 0x01 << (2 * 13); // MODER13 = 01 → PC13 as output

		// setup PA2 USART (TX)
		GPIOA -> MODER &= ~(0x03 << (2 * 2)); // Clear MODER2 bits
		GPIOA -> MODER |= 0x02 << (2 * 2); // MODER2 = 11 → PA2 as alternate function
		GPIOA -> AFR[0] &= ~(0x0F << (4 * 2)); // Clear AFRL2 bits
		GPIOA -> AFR[0] |= 0x07 << (4 * 2); // AFRL2 = 7 (USART2)

		// setup PA3 USART (RX)
		GPIOA -> MODER &= ~(0x03 << (2 * 3)); // Clear MODER3 bits
		GPIOA -> MODER |= 0x02 << (2 * 3); // MODER3 = 11 → PA3 as alternate function
		GPIOA -> AFR[0] &= ~(0x0F << (4 * 3)); // Clear AFRL2 bits
		GPIOA -> AFR[0] |= 0x07 << (4 * 3); // AFRL2 = 7 (USART2)

		char myString[] = "123\r\n";
		uint8_t len = strlen(myString);
		uint8_t count = 0;

		RCC -> AHB1ENR |= RCC_AHB1ENR_DMA1EN; // DMA1 clock enable
		USART2 -> CR3 |= USART_CR3_DMAT; //DMA1 Enable Transmitter

		//DMA Setup

		DMA1_Stream6->CR &= ~DMA_SxCR_CHSEL; // Clear
		DMA1_Stream6->CR |= (4 << DMA_SxCR_CHSEL_Pos); // Channel 4 = USART2_TX

		DMA1_Stream6->NDTR = len; // number of bytes
		DMA1_Stream6->PAR  = (uint32_t)&USART2->DR; // peripheral address
		DMA1_Stream6->M0AR = (uint32_t)myString; // memory address

		DMA1_Stream6->CR |= DMA_SxCR_MINC; // increment memory
		DMA1_Stream6->CR |= DMA_SxCR_DIR_0; // memory-to-peripheral
		DMA1 -> HIFCR = DMA_HIFCR_CTCIF6; // clear transfer complete flag
		DMA1_Stream6->CR |= DMA_SxCR_TCIE; // enable transfer complete interrupt
		DMA1_Stream6->CR |= DMA_SxCR_CIRC; // circular mode

		USART2 -> BRR = 1666;
		USART2 -> CR1 |= USART_CR1_TE; // turn on TX
		USART2 -> CR1 |= USART_CR1_UE; // turn on the USART peripheral

		while (1) {
			if (GPIOA->IDR & (1 << 0)) {
				// Button released
				GPIOC->ODR |= (1 << 13);
			} else {
				// Button pressed
				GPIOC->ODR &= ~(1 << 13);

//				for (count = 0; count < len; count++) {
//					USART2 -> DR = myString[count];
//					while ((USART2 -> SR & USART_SR_TC) == 0);
//				}

				DMA1 -> HIFCR = DMA_HIFCR_CTCIF6; // clear flag
				DMA1_Stream6 -> CR |= DMA_SxCR_EN; // enable DMA
				while ((DMA1 -> HISR & DMA_HISR_TCIF6) == 0); // while interrupt flag
				DMA1 -> HIFCR = DMA_HIFCR_CTCIF6; // clear flag
				DMA1_Stream6 -> CR &= ~DMA_SxCR_EN; // disable DMA
			}
		}
	}
