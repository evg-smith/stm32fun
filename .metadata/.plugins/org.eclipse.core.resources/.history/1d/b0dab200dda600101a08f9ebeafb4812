/*
 * lcd_lib.c
 *
 *  Created on: Oct 11, 2025
 *      Author: eevgs
 */
#include "lcd_lib.h"

void write_bits(uint16_t bits) {
	HAL_GPIO_WritePin(GPIOA, RS_Pin, (bits >> 9) & 1);
	HAL_GPIO_WritePin(GPIOA, RW_Pin, (bits >> 8) & 1);

	HAL_GPIO_WritePin(GPIOA, D7_Pin, (bits >> 7) & 1);
	HAL_GPIO_WritePin(GPIOA, D6_Pin, (bits >> 6) & 1);
	HAL_GPIO_WritePin(GPIOA, D5_Pin, (bits >> 5) & 1);
	HAL_GPIO_WritePin(GPIOA, D4_Pin, (bits >> 4) & 1);

	HAL_Delay(1);
	HAL_GPIO_WritePin(GPIOA, EN_Pin, 1);
	HAL_Delay(1);
	HAL_GPIO_WritePin(GPIOA, EN_Pin, 0);
	HAL_Delay(1);

	HAL_GPIO_WritePin(GPIOA, D7_Pin, (bits >> 3) & 1);
	HAL_GPIO_WritePin(GPIOA, D6_Pin, (bits >> 2) & 1);
	HAL_GPIO_WritePin(GPIOA, D5_Pin, (bits >> 1) & 1);
	HAL_GPIO_WritePin(GPIOA, D4_Pin, (bits >> 0) & 1);

	HAL_Delay(1);
	HAL_GPIO_WritePin(GPIOA, EN_Pin, 1);
	HAL_Delay(1);
	HAL_GPIO_WritePin(GPIOA, EN_Pin, 0);
	HAL_Delay(1);
}

void write_nibble(uint8_t nibble) {
    HAL_GPIO_WritePin(GPIOA, D7_Pin, (nibble >> 3) & 1);
    HAL_GPIO_WritePin(GPIOA, D6_Pin, (nibble >> 2) & 1);
    HAL_GPIO_WritePin(GPIOA, D5_Pin, (nibble >> 1) & 1);
    HAL_GPIO_WritePin(GPIOA, D4_Pin, (nibble >> 0) & 1);

    HAL_Delay(1);
    HAL_GPIO_WritePin(GPIOA, EN_Pin, 1);
    HAL_Delay(1);
    HAL_GPIO_WritePin(GPIOA, EN_Pin, 0);
    HAL_Delay(1);
}

void LCD_Init(void) {
	// Ensure RS and RW are low
		HAL_GPIO_WritePin(GPIOA, RS_Pin, 0);
		HAL_GPIO_WritePin(GPIOA, RW_Pin, 0);

		// Wait for LCD to power up (>40ms after Vcc rises to 4.5V)
		HAL_Delay(50);

		// Start initialization sequence for 4-bit mode
		// Send 0x03 three times (8-bit mode reset sequence)
//		write_nibble(0x03);
//		HAL_Delay(5);  // Wait >4.1ms
//
//		write_nibble(0x03);
//		HAL_Delay(1);  // Wait >100us
//
//		write_nibble(0x03);
//		HAL_Delay(1);
//
//		// Switch to 4-bit mode
//		write_nibble(0x02);
//		HAL_Delay(1);

		// Now we can use write_bits for full commands
		// Function set: 4-bit mode, 2 lines, 5x8 font
		write_bits(0b00101000);  // 0x28
		HAL_Delay(1);

		// Display off
		write_bits(0b00001000);  // 0x08
		HAL_Delay(1);

		// Clear display
		write_bits(0b00000001);  // 0x01
		HAL_Delay(2);

		// Entry mode set: increment cursor, no shift
		write_bits(0b00000110);  // 0x06
		HAL_Delay(1);

		// Display on, cursor off, blink off
		write_bits(0b00001100);  // 0x0C
		HAL_Delay(2);
}

void write_char(char c) {
	write_bits((0b10 << 8) | c);
}

void write_string(char *str) {
    while (*str != '\0') {
        write_char(*str);
        str++;
    }
}
