/*
 * lcd_lib.c
 *
 *  Created on: Oct 11, 2025
 *      Author: eevgs
 */
#include "lcd_lib.h"

void write_nibble(uint8_t nibble) {
	HAL_GPIO_WritePin(GPIOA, D7_Pin, (nibble >> 3) & 1);
	HAL_GPIO_WritePin(GPIOA, D6_Pin, (nibble >> 2) & 1);
	HAL_GPIO_WritePin(GPIOA, D5_Pin, (nibble >> 1) & 1);
	HAL_GPIO_WritePin(GPIOA, D4_Pin, (nibble >> 0) & 1);

	HAL_Delay(1);
	HAL_GPIO_WritePin(GPIOA, EN_Pin, 1);
	HAL_Delay(1);
	HAL_GPIO_WritePin(GPIOA, EN_Pin, 0);
	HAL_Delay(1);
}

void write_bits(uint16_t bits) {
	HAL_GPIO_WritePin(GPIOA, RS_Pin, (bits >> 9) & 1);
	HAL_GPIO_WritePin(GPIOA, RW_Pin, (bits >> 8) & 1);

	write_nibble(bits >> 4); // upper nibble
	write_nibble(bits); // lower nibble
}

void LCD_Init(void) {

	HAL_Delay(50);

	// Single 0x2 nibble to set 4-bit mode (sent as 8-bit initially)
	HAL_GPIO_WritePin(GPIOA, RS_Pin, 0);
	HAL_GPIO_WritePin(GPIOA, RW_Pin, 0);
	HAL_GPIO_WritePin(GPIOA, D7_Pin, 0);
	HAL_GPIO_WritePin(GPIOA, D6_Pin, 0);
	HAL_GPIO_WritePin(GPIOA, D5_Pin, 1);
	HAL_GPIO_WritePin(GPIOA, D4_Pin, 0);

	HAL_Delay(1);
	HAL_GPIO_WritePin(GPIOA, EN_Pin, 1);
	HAL_Delay(1);
	HAL_GPIO_WritePin(GPIOA, EN_Pin, 0);
	HAL_Delay(1);

	// Now use write_bits - LCD is in 4-bit mode
//	write_bits(0b00101000); // 4-bit, 2 lines, 5x8
//	write_bits(0b00001100); // display on
//	write_bits(0b00000001); // clear

	write_bits(0b00101000);  // 4-bit mode, 2 lines, 5x8 font
	write_bits(0b00001100);  // display on
	write_bits(0b00000110);  // entry mode set
	HAL_Delay(2); // required after clear
}

void write_char(char c) {
	write_bits((0b10 << 8) | c);
}

void write_string(char *str) {
	while (*str)write_char(*str++);
}
